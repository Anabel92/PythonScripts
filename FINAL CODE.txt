import requests
import base64
import json
from datetime import datetime
import logging
import serial
import pynmea2
from picamera import PiCamera

logging.basicConfig(filename='pdtlog.log',level=logging.INFO)
dateTimeObj = datetime.now()
camera = PiCamera()

port = "/dev/serial0"
 
def parseGPS(str):
    if str.find('GGA') > 0:
        msg = pynmea2.parse(str)
        print ("Lat: %s %s -- Lon: %s %s -- Altitude: %s %s -- Satellites: %s" % (msg.lat,msg.lat_dir,msg.lon,msg.lon_dir,msg.altitude,msg.altitude_units,msg.num_sats))
 
 
serialPort = serial.Serial(port, baudrate = 9600, timeout = 0.5)

print(dateTimeObj)

for i in range(5):
    str = serialPort.readline()
    parseGPS(str)
    

camera.capture('/home/pi/Project/Image.jpg')

IMAGE_PATH='/home/pi/Project/Image.jpg'
    
SECRET_KEY='sk_d478fff1a6027dcf8dc6a305'

with open(IMAGE_PATH, 'rb') as image_file:
        img_base64 = base64.b64encode(image_file.read())

        url = 'https://api.openalpr.com/v2/recognize_bytes?recognize_vehicle=1&country=us&secret_key=%s' % (SECRET_KEY)
        r = requests.post(url, data=img_base64)
        
        #print(json.dumps(r.json(), indent=2))
        print("License Plate: " + r.json()['results'][0]['plate'] + "  State: " + r.json()['results'][0]['region'])

